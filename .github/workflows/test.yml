name: Test

permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # TypeScript tests using pnpm monorepo with Playwright container
  typescript:
    name: TypeScript
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-noble
      options: --user 1001

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm run build

      - name: Run tests
        run: pnpm test

  # Python tests using matrix for all packages
  python:
    name: Python (${{ matrix.package }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: [capnweb, dotdo, rpc, oauth]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ matrix.package }}-${{ hashFiles(format('packages/python/{0}/pyproject.toml', matrix.package)) }}
          restore-keys: |
            ${{ runner.os }}-uv-${{ matrix.package }}-
            ${{ runner.os }}-uv-

      - name: Install and test
        working-directory: packages/python/${{ matrix.package }}
        run: |
          uv sync --extra test
          uv run pytest -v

  # Rust tests using matrix for all packages
  rust:
    name: Rust (${{ matrix.package }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: [capnweb, dotdo, rpc, oauth]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles(format('packages/rust/{0}/Cargo.lock', matrix.package)) }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Cargo build
        uses: actions/cache@v4
        with:
          path: packages/rust/${{ matrix.package }}/target
          key: ${{ runner.os }}-cargo-build-${{ matrix.package }}-${{ hashFiles(format('packages/rust/{0}/Cargo.toml', matrix.package)) }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-${{ matrix.package }}-

      - name: Run tests
        working-directory: packages/rust/${{ matrix.package }}
        run: cargo test --verbose

  # Go tests using matrix for all packages
  go:
    name: Go (${{ matrix.package }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: [capnweb, dotdo, rpc, oauth]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache-dependency-path: packages/go/${{ matrix.package }}/go.sum

      - name: Run tests
        working-directory: packages/go/${{ matrix.package }}
        run: go test -v ./...

  # Cross-language conformance tests against a shared test server
  conformance:
    name: Conformance Tests
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-noble
      options: --user 1001

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Node dependencies
        run: pnpm install --frozen-lockfile

      - name: Build TypeScript
        run: pnpm run build

      - name: Start test server
        run: |
          # Start the conformance test server in the background
          npx tsx test/server/server.ts --port 8787 &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV

          # Wait for server to be ready
          for i in {1..30}; do
            if curl -s http://localhost:8787/health > /dev/null 2>&1; then
              echo "Test server is ready"
              break
            fi
            echo "Waiting for test server... ($i/30)"
            sleep 1
          done

          # Verify server is running
          if ! curl -s http://localhost:8787/health > /dev/null 2>&1; then
            echo "Test server failed to start"
            exit 1
          fi

      # TypeScript conformance tests
      - name: Run TypeScript conformance tests
        env:
          TEST_SERVER_URL: http://localhost:8787
          TEST_SPEC_DIR: ${{ github.workspace }}/test/conformance
        run: pnpm test -- --reporter=verbose

      # Python setup and tests
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Run Python conformance tests (rpc)
        env:
          TEST_SERVER_URL: http://localhost:8787
          TEST_SPEC_DIR: ${{ github.workspace }}/test/conformance
        working-directory: packages/python/rpc
        run: |
          uv sync --extra test
          uv run pytest tests/test_conformance.py -v

      - name: Run Python conformance tests (capnweb)
        env:
          TEST_SERVER_URL: http://localhost:8787
          TEST_SPEC_DIR: ${{ github.workspace }}/test/conformance
        working-directory: packages/python/capnweb
        run: |
          uv sync --extra test
          uv run pytest tests/test_conformance.py -v || echo "Python capnweb conformance tests not yet implemented"

      # Rust setup and tests
      - name: Setup Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-conformance-${{ hashFiles('packages/rust/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-conformance-

      - name: Run Rust conformance tests (rpc)
        env:
          TEST_SERVER_URL: ws://localhost:8787
          TEST_SPEC_DIR: ${{ github.workspace }}/test/conformance
        working-directory: packages/rust/rpc
        run: cargo test --test conformance --verbose || echo "Rust rpc conformance tests not yet implemented"

      - name: Run Rust conformance tests (capnweb)
        env:
          TEST_SERVER_URL: ws://localhost:8787
          TEST_SPEC_DIR: ${{ github.workspace }}/test/conformance
        working-directory: packages/rust/capnweb
        run: cargo test --test conformance --verbose || echo "Rust capnweb conformance tests not yet implemented"

      # Go setup and tests
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache-dependency-path: packages/go/**/go.sum

      - name: Run Go conformance tests (rpc)
        env:
          TEST_SERVER_URL: ws://localhost:8787
          TEST_SPEC_DIR: ${{ github.workspace }}/test/conformance
        working-directory: packages/go/rpc
        run: go test -v -run TestConformance ./... || echo "Go rpc conformance tests not yet implemented"

      - name: Run Go conformance tests (capnweb)
        env:
          TEST_SERVER_URL: ws://localhost:8787
          TEST_SPEC_DIR: ${{ github.workspace }}/test/conformance
        working-directory: packages/go/capnweb
        run: go test -v -run TestConformance ./... || echo "Go capnweb conformance tests not yet implemented"

      - name: Stop test server
        if: always()
        run: |
          if [ -n "$SERVER_PID" ]; then
            kill $SERVER_PID 2>/dev/null || true
          fi

  # Summary job to ensure all tests pass before merging
  test-summary:
    name: All Tests
    runs-on: ubuntu-latest
    needs: [typescript, python, rust, go, conformance]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [[ "${{ needs.typescript.result }}" == "failure" || \
                "${{ needs.python.result }}" == "failure" || \
                "${{ needs.rust.result }}" == "failure" || \
                "${{ needs.go.result }}" == "failure" || \
                "${{ needs.conformance.result }}" == "failure" ]]; then
            echo "One or more test jobs failed"
            exit 1
          fi
          echo "All language tests passed!"
